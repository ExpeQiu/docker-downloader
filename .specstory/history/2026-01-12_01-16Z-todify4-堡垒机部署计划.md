<!-- Generated by SpecStory, Markdown v2.1.0 -->

<!-- cursor Session 80f627a7-8d9c-40eb-91c7-f7fa54abdbcd (2026-01-12 01:16Z) -->

# Todify4 堡垒机部署计划 (2026-01-12 01:16Z)

_**User (2026-01-12 09:48Z)**_

参考 @07Docker/堡垒机/Gbaskill.md 构建 项目 todify4的堡垒机部署计划

---

_**Agent (model composer-1, mode Agent)**_



---


查看 todify4 的 Docker 配置和部署脚本，以便制定堡垒机部署计划。


---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: /Volumes/Lexar/git/03T/todify4/docker/docker-compose.yml</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: /Volumes/Lexar/git/03T/todify4/docker/docker-compose.postgres.yml</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: /Volumes/Lexar/git/03T/todify4/backend/Dockerfile</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: /Volumes/Lexar/git/03T/todify4/frontend/Dockerfile</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: /Volumes/Lexar/git/03T/todify4/deploy/deploy-todify4-docker.sh</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: /Volumes/Lexar/git/03T/todify4/backend/package.json</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: /Volumes/Lexar/git/03T/todify4/frontend/package.json</summary>

</details>
</tool-use>

---



---


查看 nginx 配置，完善部署计划：


---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: /Volumes/Lexar/git/03T/todify4/docker/nginx.conf</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: /Volumes/Lexar/git/03T/todify4/frontend/nginx.conf</summary>

</details>
</tool-use>

---



---


基于 `Gbaskill.md` 模板，创建 todify4 的堡垒机部署计划文档。


---

<tool-use data-tool-type="write" data-tool-name="write">

<details><summary>Tool use: **write** • Edit file: /Volumes/Lexar/git/07Docker/堡垒机/todify4-bastion-deploy.md</summary>

**Chunk 1**
Lines added: 419, lines removed: 1

```diff
@@ -1,1 +1,419 @@
- 
+ # Todify4 堡垒机 Docker 服务部署计划
+ 
+ &gt; **说明**: 本文档详细描述如何通过堡垒机上传 Docker 镜像并在云服务器上部署 Todify4 全套服务（数据库、后端、前端、Nginx）。
+ 
+ **目标部署服务器 IP**: &#96;10.133.23.136&#96;
+ 
+ ## 1. 环境准备与文件上传
+ 
+ ### 1.1 文件上传
+ 使用 &#96;rz&#96; 命令将本地打包好的 Docker 镜像包上传到堡垒机/服务器。
+ 
+ &#96;&#96;&#96;bash
+ # 上传文件 (使用 -be 参数避免二进制传输错误)
+ rz -be
+ &#96;&#96;&#96;
+ 
+ ### 1.2 验证文件
+ 上传完成后，验证文件是否存在及大小是否正确。
+ 
+ &#96;&#96;&#96;bash
+ ls -lh todify4-all-v1.0.tar
+ &#96;&#96;&#96;
+ 
+ ## 2. Docker 环境准备
+ 
+ ### 2.1 启动 Docker 服务
+ 如果 Docker 未启动，需执行以下命令。
+ 
+ &#96;&#96;&#96;bash
+ # 启动 Docker
+ systemctl start docker
+ 
+ # 设置开机自启
+ systemctl enable docker
+ &#96;&#96;&#96;
+ 
+ ### 2.2 验证 Docker 版本
+ 确保 Docker 已安装且版本符合要求。
+ 
+ &#96;&#96;&#96;bash
+ docker version
+ &#96;&#96;&#96;
+ 
+ ## 3. 镜像加载与网络配置
+ 
+ ### 3.1 加载镜像
+ 将上传的 tar 包还原为 Docker 镜像。
+ 
+ &#96;&#96;&#96;bash
+ docker load -i todify4-all-v1.0.tar
+ &#96;&#96;&#96;
+ 
+ ### 3.2 验证镜像
+ &#96;&#96;&#96;bash
+ docker images | grep todify4
+ &#96;&#96;&#96;
+ 
+ 预期输出应包含：
+ - &#96;todify4-backend:latest&#96;
+ - &#96;todify4-frontend:latest&#96;
+ - &#96;postgres:15-alpine&#96; (如果使用 PostgreSQL)
+ 
+ ### 3.3 创建内部网络
+ 创建 Docker 内部网络以便容器间通过服务名通信。
+ 
+ &#96;&#96;&#96;bash
+ docker network create todify4-network
+ &#96;&#96;&#96;
+ 
+ ## 4. 端口规划与服务启动
+ 
+ &gt; **⚠️ 重要提示 (端口冲突风险)**
+ &gt; 在启动服务前，**必须**检查服务器端口占用情况，避免与现有服务（如 Nginx, 其他 Docker 容器）或总服务器进程发生冲突。
+ &gt; 
+ &gt; *   **Todify4 使用的端口**: &#96;8111&#96; (前端), &#96;8113&#96; (后端), &#96;8118&#96; (Nginx), &#96;5432&#96; (PostgreSQL，如果使用)
+ &gt; *   **检查命令**:
+ &gt;     &#96;&#96;&#96;bash
+ &gt;     # 检查所有监听端口
+ &gt;     netstat -tulpn
+ &gt;     
+ &gt;     # 检查特定端口 (例如 8113)
+ &gt;     netstat -tulpn | grep 8113
+ &gt;     &#96;&#96;&#96;
+ &gt; *   **解决冲突**: 如果目标端口已被占用，请修改 &#96;docker run&#96; 命令中的主机映射端口 (例如 &#96;-p &lt;新端口&gt;:8113&#96;)。
+ 
+ ### 4.1 启动数据库
+ 
+ #### 方案 A: 使用 SQLite (默认，无需单独容器)
+ SQLite 数据库文件存储在容器内的 &#96;/app/data&#96; 目录，通过数据卷挂载持久化。
+ 
+ #### 方案 B: 启动 PostgreSQL 数据库 (可选)
+ 如果需要使用 PostgreSQL，执行以下命令：
+ 
+ &#96;&#96;&#96;bash
+ docker run -d \
+   --name todify4-postgres \
+   --network todify4-network \
+   --restart always \
+   -e POSTGRES_USER=postgres \
+   -e POSTGRES_PASSWORD=postgres \
+   -e POSTGRES_DB=todify4 \
+   -v todify4-postgres-data:/var/lib/postgresql/data \
+   -p 5432:5432 \
+   postgres:15-alpine
+ &#96;&#96;&#96;
+ 
+ **注意**: 如果 &#96;5432&#96; 端口被占用，请修改 &#96;-p 5432:5432&#96; 为 &#96;-p &lt;可用端口&gt;:5432&#96;。
+ 
+ ### 4.2 启动后端服务 (Backend)
+ 后端监听 8113 端口，并连接数据库。
+ 
+ **注意**: 如果 &#96;8113&#96; 被占用，请将 &#96;-p 8113:8113&#96; 修改为 &#96;-p &lt;可用端口&gt;:8113&#96;。
+ 
+ #### SQLite 模式启动：
+ &#96;&#96;&#96;bash
+ docker run -d \
+   --name todify4-backend \
+   --network todify4-network \
+   --restart always \
+   -p 8113:8113 \
+   -e NODE_ENV=production \
+   -e PORT=8113 \
+   -e DB_TYPE=sqlite \
+   -e SQLITE_DB_PATH=./data/todify4.db \
+   -e INIT_DATABASE=1 \
+   -v $(pwd)/backend-data:/app/data \
+   -v $(pwd)/backend-uploads:/app/uploads \
+   todify4-backend:latest
+ &#96;&#96;&#96;
+ 
+ #### PostgreSQL 模式启动：
+ &#96;&#96;&#96;bash
+ docker run -d \
+   --name todify4-backend \
+   --network todify4-network \
+   --restart always \
+   -p 8113:8113 \
+   -e NODE_ENV=production \
+   -e PORT=8113 \
+   -e DB_TYPE=postgresql \
+   -e PG_HOST=todify4-postgres \
+   -e PG_PORT=5432 \
+   -e PG_USER=postgres \
+   -e PG_PASSWORD=postgres \
+   -e PG_DATABASE=todify4 \
+   -v $(pwd)/backend-uploads:/app/uploads \
+   todify4-backend:latest
+ &#96;&#96;&#96;
+ 
+ **环境变量说明**:
+ - &#96;DB_TYPE&#96;: 数据库类型 (&#96;sqlite&#96; 或 &#96;postgresql&#96;)
+ - &#96;INIT_DATABASE&#96;: 是否初始化数据库 (&#96;1&#96; 为是, &#96;0&#96; 为否)
+ - &#96;DIFY_BASE_URL&#96;: Dify API 基础 URL (可选)
+ - &#96;AI_SEARCH_API_KEY&#96;: AI 搜索 API 密钥 (可选)
+ 
+ ### 4.3 启动前端服务 (Frontend)
+ 前端对外暴露 8111 端口（映射到容器内 80 端口）。
+ 
+ **注意**: &#96;8111&#96; 端口如果被占用，请修改为其他端口（如 &#96;8112&#96;）。
+ 
+ &#96;&#96;&#96;bash
+ docker run -d \
+   --name todify4-frontend \
+   --network todify4-network \
+   --restart always \
+   -p 8111:80 \
+   todify4-frontend:latest
+ &#96;&#96;&#96;
+ 
+ ### 4.4 启动 Nginx 反向代理 (可选)
+ Nginx 对外暴露 8118 端口，统一代理前端和后端服务。
+ 
+ **注意**: &#96;8118&#96; 端口如果被占用，请修改为其他端口。
+ 
+ &#96;&#96;&#96;bash
+ docker run -d \
+   --name todify4-nginx \
+   --network todify4-network \
+   --restart always \
+   -p 8118:80 \
+   -v $(pwd)/nginx.conf:/etc/nginx/conf.d/default.conf:ro \
+   nginx:alpine
+ &#96;&#96;&#96;
+ 
+ **Nginx 配置文件示例** (&#96;nginx.conf&#96;):
+ &#96;&#96;&#96;nginx
+ server {
+     listen 80;
+     server_name _;
+     
+     # 前端代理
+     location / {
+         proxy_pass http://todify4-frontend:80;
+         proxy_set_header Host $host;
+         proxy_set_header X-Real-IP $remote_addr;
+         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
+     }
+     
+     # API 代理到后端
+     location /api/ {
+         proxy_pass http://todify4-backend:8113/api/;
+         proxy_set_header Host $host;
+         proxy_set_header X-Real-IP $remote_addr;
+         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
+     }
+ }
+ &#96;&#96;&#96;
+ 
+ ## 5. 验证与访问
+ 
+ ### 5.1 检查容器状态
+ &#96;&#96;&#96;bash
+ docker ps | grep todify4
+ &#96;&#96;&#96;
+ 
+ ### 5.2 访问测试
+ 假设服务器 IP 为 &#96;10.133.23.136&#96; (请根据实际情况调整端口)。
+ 
+ *   **前端访问**: 
+     *   浏览器: &#96;http://10.133.23.136:8111&#96; (直接访问前端)
+     *   或通过 Nginx: &#96;http://10.133.23.136:8118&#96; (推荐)
+     *   本地测试: &#96;curl http://localhost:8111&#96;
+ *   **后端访问**: 
+     *   API 健康检查: &#96;http://10.133.23.136:8113/api/health&#96;
+     *   或通过 Nginx: &#96;http://10.133.23.136:8118/api/health&#96;
+     *   本地测试: &#96;curl http://localhost:8113/api/health&#96;
+ 
+ ### 5.3 查看容器日志
+ &#96;&#96;&#96;bash
+ # 查看后端日志
+ docker logs --tail 50 todify4-backend
+ 
+ # 查看前端日志
+ docker logs --tail 50 todify4-frontend
+ 
+ # 查看数据库日志 (如果使用 PostgreSQL)
+ docker logs --tail 50 todify4-postgres
+ &#96;&#96;&#96;
+ 
+ ## 6. 防火墙配置
+ 
+ 确保云服务器安全组已放行您规划的 **实际映射端口**。如果服务器内部开启了防火墙 (&#96;firewalld&#96;)，需手动放行。
+ 
+ &#96;&#96;&#96;bash
+ # 检查防火墙状态
+ systemctl status firewalld
+ 
+ # 开放端口 (以 8111, 8113, 8118 为例，请替换为您实际使用的端口)
+ firewall-cmd --permanent --add-port=8111/tcp
+ firewall-cmd --permanent --add-port=8113/tcp
+ firewall-cmd --permanent --add-port=8118/tcp
+ firewall-cmd --reload
+ 
+ # 临时关闭防火墙 (仅用于测试)
+ # systemctl stop firewalld
+ &#96;&#96;&#96;
+ 
+ ## 7. 数据导入 (可选)
+ 
+ ### 7.1 SQLite 数据迁移
+ 如果需要迁移现有的 SQLite 数据库文件：
+ 
+ &#96;&#96;&#96;bash
+ # 停止后端容器
+ docker stop todify4-backend
+ 
+ # 复制数据库文件到数据目录
+ cp /path/to/existing/todify4.db $(pwd)/backend-data/
+ 
+ # 重新启动后端容器
+ docker start todify4-backend
+ &#96;&#96;&#96;
+ 
+ ### 7.2 PostgreSQL 数据导入
+ 如果需要从 SQLite 迁移数据到 PostgreSQL：
+ 
+ &#96;&#96;&#96;bash
+ # 上传 SQL 文件到服务器
+ rz -be
+ 
+ # 复制 SQL 文件到容器
+ docker cp /root/sqlite-to-postgres-*.sql todify4-postgres:/tmp/import-data.sql
+ 
+ # 执行导入
+ docker exec todify4-postgres psql -U postgres -d todify4 -f /tmp/import-data.sql
+ &#96;&#96;&#96;
+ 
+ ### 7.3 上传文件同步
+ 如果需要同步上传的文件：
+ 
+ &#96;&#96;&#96;bash
+ # 创建上传目录
+ mkdir -p $(pwd)/backend-uploads
+ 
+ # 复制文件到上传目录
+ cp -r /path/to/uploads/* $(pwd)/backend-uploads/
+ 
+ # 重启后端容器使挂载生效
+ docker restart todify4-backend
+ &#96;&#96;&#96;
+ 
+ ## 8. 异常排查
+ 
+ 如果服务启动失败，查看容器日志。
+ 
+ &#96;&#96;&#96;bash
+ # 查看数据库日志 (如果使用 PostgreSQL)
+ docker logs --tail 50 todify4-postgres
+ 
+ # 查看后端日志
+ docker logs --tail 50 todify4-backend
+ 
+ # 查看前端日志
+ docker logs --tail 50 todify4-frontend
+ 
+ # 查看 Nginx 日志
+ docker logs --tail 50 todify4-nginx
+ &#96;&#96;&#96;
+ 
+ ### 8.1 常见问题
+ 
+ #### 问题 1: 后端无法连接数据库
+ **症状**: 后端日志显示数据库连接错误。
+ 
+ **解决方案**:
+ - SQLite 模式: 检查数据卷挂载是否正确，确保 &#96;/app/data&#96; 目录可写
+ - PostgreSQL 模式: 检查 &#96;PG_HOST&#96; 环境变量是否为 &#96;todify4-postgres&#96;，确保 PostgreSQL 容器已启动
+ 
+ #### 问题 2: 前端无法访问后端 API
+ **症状**: 前端页面显示 API 请求失败。
+ 
+ **解决方案**:
+ - 检查后端容器是否正常运行: &#96;docker ps | grep todify4-backend&#96;
+ - 检查网络连接: &#96;docker network inspect todify4-network&#96;
+ - 检查后端健康状态: &#96;curl http://localhost:8113/api/health&#96;
+ 
+ #### 问题 3: 端口冲突
+ **症状**: 容器启动失败，提示端口已被占用。
+ 
+ **解决方案**:
+ - 检查端口占用: &#96;netstat -tulpn | grep &lt;端口号&gt;&#96;
+ - 修改 &#96;docker run&#96; 命令中的端口映射，使用其他可用端口
+ - 或停止占用端口的服务
+ 
+ ## 9. 服务管理命令
+ 
+ ### 9.1 启动服务
+ &#96;&#96;&#96;bash
+ # 启动所有服务
+ docker start todify4-backend todify4-frontend todify4-nginx
+ 
+ # 如果使用 PostgreSQL
+ docker start todify4-postgres todify4-backend todify4-frontend todify4-nginx
+ &#96;&#96;&#96;
+ 
+ ### 9.2 停止服务
+ &#96;&#96;&#96;bash
+ # 停止所有服务
+ docker stop todify4-backend todify4-frontend todify4-nginx
+ 
+ # 如果使用 PostgreSQL
+ docker stop todify4-postgres todify4-backend todify4-frontend todify4-nginx
+ &#96;&#96;&#96;
+ 
+ ### 9.3 重启服务
+ &#96;&#96;&#96;bash
+ # 重启单个服务
+ docker restart todify4-backend
+ 
+ # 重启所有服务
+ docker restart todify4-backend todify4-frontend todify4-nginx
+ &#96;&#96;&#96;
+ 
+ ### 9.4 删除服务
+ &#96;&#96;&#96;bash
+ # 停止并删除容器
+ docker stop todify4-backend todify4-frontend todify4-nginx
+ docker rm todify4-backend todify4-frontend todify4-nginx
+ 
+ # 如果使用 PostgreSQL
+ docker stop todify4-postgres
+ docker rm todify4-postgres
+ docker volume rm todify4-postgres-data
+ 
+ # 删除网络
+ docker network rm todify4-network
+ &#96;&#96;&#96;
+ 
+ ## 10. 使用 Docker Compose 部署 (推荐)
+ 
+ 如果已上传 &#96;docker-compose.yml&#96; 文件，可以使用 Docker Compose 一键部署：
+ 
+ &#96;&#96;&#96;bash
+ # 进入 docker 目录
+ cd /path/to/todify4/docker
+ 
+ # 启动所有服务
+ docker-compose up -d
+ 
+ # 查看服务状态
+ docker-compose ps
+ 
+ # 查看日志
+ docker-compose logs -f
+ 
+ # 停止服务
+ docker-compose down
+ &#96;&#96;&#96;
+ 
+ **使用 PostgreSQL 模式**:
+ &#96;&#96;&#96;bash
+ # 使用 PostgreSQL 配置
+ docker-compose -f docker-compose.yml -f docker-compose.postgres.yml up -d
+ &#96;&#96;&#96;
+ 
+ ---
+ 
+ **注意**: 本指南中的镜像名称 (&#96;todify4-*&#96;)、端口 (&#96;8111&#96;, &#96;8113&#96;, &#96;8118&#96;) 和网络名称 (&#96;todify4-network&#96;) 为 Todify4 项目的实际配置。部署时请根据实际情况调整端口映射以避免冲突。
+ 
```

</details>

</tool-use>

---



---


已创建 Todify4 的堡垒机部署计划文档。检查是否有格式问题：


---

<tool-use data-tool-type="generic" data-tool-name="read_lints">
<details>
          <summary>Tool use: **read_lints** • Read lints for 1 file</summary>
      
Lint paths:

- `/Volumes/Lexar/git/07Docker/堡垒机/todify4-bastion-deploy.md`

Lint results


**No lint errors found**
</details>
</tool-use>

---



---


已创建 Todify4 的堡垒机部署计划文档。

## 文档位置
`/Volumes/Lexar/git/07Docker/堡垒机/todify4-bastion-deploy.md`

## 主要内容

1. 环境准备：文件上传、Docker 环境检查
2. 镜像加载：镜像加载与网络创建
3. 端口规划：
   - 前端：8111
   - 后端：8113
   - Nginx：8118
   - PostgreSQL：5432（可选）
4. 服务启动：
   - SQLite 模式（默认）
   - PostgreSQL 模式（可选）
   - Nginx 反向代理配置
5. 验证与访问：健康检查与访问测试
6. 防火墙配置：端口放行
7. 数据导入：SQLite/PostgreSQL 数据迁移
8. 异常排查：常见问题与解决方案
9. 服务管理：启动、停止、重启、删除命令
10. Docker Compose 部署：一键部署方案

文档基于 `Gbaskill.md` 模板，已替换为 Todify4 的实际配置（镜像名、端口、网络等），可直接用于堡垒机部署。

---

