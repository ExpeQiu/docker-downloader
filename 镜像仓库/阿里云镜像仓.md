
# 阿里云镜像仓

华南3（广州）
私有
本地仓库
正常
基本信息
仓库名称
aiforworld
aiforworld


仓库地域
华南3（广州）
仓库类型
私有
代码仓库
无
公网地址
crpi-c6gwhxgtx8ccdxfl.cn-guangzhou.personal.cr.aliyuncs.com/cyberspaceai/aiforworld
crpi-c6gwhxgtx8ccdxfl.cn-guangzhou.personal.cr.aliyuncs.com/cyberspaceai/aiforworld

专有网络
crpi-c6gwhxgtx8ccdxfl-vpc.cn-guangzhou.personal.cr.aliyuncs.com/cyberspaceai/aiforworld
crpi-c6gwhxgtx8ccdxfl-vpc.cn-guangzhou.personal.cr.aliyuncs.com/cyberspaceai/aiforworld



## 操作指南

1. 登录阿里云 Container Registry
$ docker login --username=dt_4157768178 crpi-c6gwhxgtx8ccdxfl.cn-guangzhou.personal.cr.aliyuncs.com
用于登录的用户名为阿里云账号全名，密码为开通服务时设置的密码。

您可以在访问凭证页面修改凭证密码。

注意：使用 RAM 用户（子账号）登录镜像仓库时，不支持企业别名带有英文半角句号（.）。

2. 从Registry中拉取镜像
$ docker pull crpi-c6gwhxgtx8ccdxfl.cn-guangzhou.personal.cr.aliyuncs.com/cyberspaceai/aiforworld:[镜像版本号]
3. 将镜像推送到Registry
$ docker login --username=dt_4157768178 crpi-c6gwhxgtx8ccdxfl.cn-guangzhou.personal.cr.aliyuncs.com
$ docker tag [ImageId] crpi-c6gwhxgtx8ccdxfl.cn-guangzhou.personal.cr.aliyuncs.com/cyberspaceai/aiforworld:[镜像版本号]
$ docker push crpi-c6gwhxgtx8ccdxfl.cn-guangzhou.personal.cr.aliyuncs.com/cyberspaceai/aiforworld:[镜像版本号]
请根据实际镜像信息替换示例中的[ImageId]和[镜像版本号]参数。

4. 选择合适的镜像仓库地址
从ECS推送镜像时，可以选择使用镜像仓库内网地址。推送速度将得到提升并且将不会损耗您的公网流量。

如果您使用的机器位于VPC网络，请使用 crpi-c6gwhxgtx8ccdxfl-vpc.cn-guangzhou.personal.cr.aliyuncs.com 作为Registry的域名登录。

5. 示例
使用"docker tag"命令重命名镜像，并将它通过专有网络地址推送至Registry。

$ docker images
REPOSITORY                                                         TAG                 IMAGE ID            CREATED             VIRTUAL SIZE
registry.aliyuncs.com/acs/agent                                    0.7-dfb6816         37bb9c63c8b2        7 days ago          37.89 MB
$ docker tag 37bb9c63c8b2 crpi-c6gwhxgtx8ccdxfl-vpc.cn-guangzhou.personal.cr.aliyuncs.com/acs/agent:0.7-dfb6816
使用 "docker push" 命令将该镜像推送至远程。

$ docker push crpi-c6gwhxgtx8ccdxfl-vpc.cn-guangzhou.personal.cr.aliyuncs.com/acs/agent:0.7-dfb6816

## 部署经验总结 (2026-01-16)

### 1. 解决 Docker Hub 拉取限制 (Pull Access Denied)
在国内构建环境拉取 Docker Hub 官方镜像（如 `node:20-alpine`, `nginx:alpine`）时，常遇到 `pull access denied` 或超时错误。

**解决方案**：使用国内加速镜像源（如 DaoCloud）。

**示例配置**：
在构建脚本或 Dockerfile 中替换基础镜像：
- 原地址：`node:20-alpine`
- 加速地址：`m.daocloud.io/docker.io/library/node:20-alpine`

- 原地址：`nginx:alpine`
- 加速地址：`m.daocloud.io/docker.io/library/nginx:alpine`

**脚本中使用 Build Args 传递**：
```bash
docker buildx build \
  --build-arg BASE_IMAGE=m.daocloud.io/docker.io/library/node:20-alpine \
  ...
```

### 2. 构建脚本日志与实时输出
避免在 Shell 脚本中将 Docker 构建命令的输出完全捕获到变量中（如 `OUTPUT=$(docker build ...)`），这会导致：
1.  构建过程中终端无任何输出，造成“卡死”假象。
2.  发生错误时无法及时看到报错信息。
3.  自动化监控脚本（如 `check-build-progress.sh`）无法获取日志文件。

**推荐写法**：
使用 `tee` 命令同时输出到终端和日志文件：
```bash
docker buildx build ... 2>&1 | tee /tmp/build-log.log
```

### 3. 多架构构建 (Buildx)
确保使用 `docker buildx` 支持跨平台构建（如在 M1/M2 Mac 上构建 Linux/AMD64 镜像），并显式指定 `--platform linux/amd64`。

## 4. 云服务器端更新操作指南

如果服务器上已经运行了旧版本（Docker 或 Docker Compose 部署），请按以下步骤无缝更新。

### 方式一：使用 Docker Compose（推荐）
适用于使用 `docker-compose.yml` 管理多容器服务的场景。

1.  **登录镜像仓库**（若未登录）
    ```bash
    docker login --username=dt_4157768178 crpi-c6gwhxgtx8ccdxfl.cn-guangzhou.personal.cr.aliyuncs.com
    ```

2.  **拉取最新镜像**
    ```bash
    # 拉取所有服务定义的最新镜像
    docker-compose pull
    
    # 或者指定服务拉取 (例如 todify4-backend)
    docker-compose pull todify4-backend
    ```

3.  **重新部署服务**
    Docker Compose 会自动检测镜像变化，并仅重启有更新的容器。
    ```bash
    docker-compose up -d
    ```

4.  **验证状态**
    ```bash
    docker-compose ps
    docker-compose logs -f --tail=100
    ```

### 方式二：手动 Docker 命令
适用于单容器部署。

1.  **拉取新镜像**
    ```bash
    docker pull crpi-c6gwhxgtx8ccdxfl.cn-guangzhou.personal.cr.aliyuncs.com/cyberspaceai/aiforworld:latest
    ```

2.  **停止并删除旧容器**
    ```bash
    docker stop my-app-container
    docker rm my-app-container
    ```

3.  **启动新容器**
    ```bash
    docker run -d --name my-app-container \
      -p 80:80 \
      --restart always \
      crpi-c6gwhxgtx8ccdxfl.cn-guangzhou.personal.cr.aliyuncs.com/cyberspaceai/aiforworld:latest
    ```

### 5. 清理旧镜像（释放空间）
更新完成后，建议清理未被使用的“悬空”镜像（Dangling Images）。
```bash
docker image prune -f
```
