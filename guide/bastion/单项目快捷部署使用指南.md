# 单项目快捷部署使用指南

## 概述

为 TPD2、Writer、Todify4 三个项目分别创建了独立的快捷部署方案。每个项目都有完整的部署包构建和部署脚本。

## 项目部署脚本位置

- **TPD2**: `/Volumes/Lexar/git/03T/TPD2/deploy/`
- **Writer**: `/Volumes/Lexar/git/03T/writer/deploy/`
- **Todify4**: `/Volumes/Lexar/git/03T/todify4/deploy/`

## 部署流程

### 第一步：本地构建部署包

在每个项目根目录执行打包脚本：

```bash
# TPD2
cd /Volumes/Lexar/git/03T/TPD2
./deploy/build-deploy-package.sh v1.1

# Writer
cd /Volumes/Lexar/git/03T/writer
./deploy/build-deploy-package.sh latest

# Todify4
cd /Volumes/Lexar/git/03T/todify4
./deploy/build-deploy-package.sh latest
```

打包脚本会自动：
1. **构建 Docker 镜像**（Mac M1/M2 自动使用 `--platform linux/amd64`）
2. **导出本地数据**（自动检测并导出 SQLite/PostgreSQL 数据）
3. **导出镜像为 tar 文件**
4. **复制配置文件和部署脚本**
5. **创建部署说明文档**
6. **打包为 `项目名-deploy-版本.tar.gz`**

**数据导出说明**：
- TPD2: 自动导出本地数据库数据到 `data/init-data.sql`
- Writer/Todify4: 数据通过 Docker Volume 持久化，无需单独导出
- 如果本地没有数据，部署包会包含空的数据目录

### 第二步：上传到服务器

使用 WindTerm 或其他 SFTP 工具将生成的 `.tar.gz` 文件上传到服务器 `/root/` 目录。

**注意**：Writer 镜像可能较大（约 2.3G），建议使用支持断点续传的 SFTP 工具。

### 第三步：服务器端部署

在服务器上执行：

```bash
# 1. 解压部署包
tar -xzf tpd2-deploy-v1.1.tar.gz
cd tpd2-deploy-v1.1

# 2. （可选）修改配置
vi config/.env

# 重要配置项（TPD2）:
# - AUTO_IMPORT_DATA=true  # 是否自动导入数据（默认 false）
# - PG_PASSWORD=your_password  # 数据库密码
# - JWT_SECRET=your_secret  # JWT 密钥

# 3. 清理旧服务
./scripts/cleanup.sh

# 4. 执行部署（会自动导入数据，如果 AUTO_IMPORT_DATA=true）
./scripts/deploy.sh

# 5. 验证部署
./scripts/verify.sh

# 6. （可选）如果数据未自动导入，手动导入
# ./scripts/import-data.sh ../data/init-data.sql
```

## 部署脚本说明

### cleanup.sh - 清理脚本

停止并删除旧服务，可选参数：
- `--volumes`: 同时删除数据卷
- `--images`: 同时删除镜像

```bash
./scripts/cleanup.sh              # 只删除容器
./scripts/cleanup.sh --volumes    # 删除容器和数据卷
./scripts/cleanup.sh --images     # 删除容器和镜像
./scripts/cleanup.sh --volumes --images  # 完全清理
```

### deploy.sh - 部署脚本

一键部署新版本，自动执行：
1. 检查 Docker 环境
2. 加载 Docker 镜像
3. 创建 Docker 网络
4. 启动数据库（如需要）
5. 导入数据（如果配置了 `AUTO_IMPORT_DATA=true`）
6. 启动后端服务
7. 启动前端服务
8. 启动 Nginx（Todify4）

```bash
./scripts/deploy.sh
```

### verify.sh - 验证脚本

检查部署是否成功：
- 容器运行状态
- 数据库连接（如适用）
- 后端健康检查
- 前端服务访问
- 端口监听状态

```bash
./scripts/verify.sh
```

## 端口规划

| 项目 | 前端端口 | 后端端口 | 数据库端口 | Nginx端口 |
|------|---------|---------|-----------|-----------|
| TPD2 | 8181 | 8180 | 5433 | - |
| Writer | 8381 | 8380 | - | - |
| Todify4 | 8281 | 8280 | 5434 | 8288 |

## 路径配置

所有项目已配置正确的 basePath，可通过 Unified Portal 访问：

- TPD2: `http://10.133.23.136/tpd2/`
- Writer: `http://10.133.23.136/writer/`
- Todify4: `http://10.133.23.136/todify/`

## 配置文件说明

每个部署包包含 `config/.env` 配置文件，主要配置项：

### TPD2
```bash
PROJECT_NAME=tpd2
VERSION=v1.1
FRONTEND_PORT=8181
BACKEND_PORT=8180
PG_PORT=5433
PG_USER=postgres
PG_PASSWORD=your_secure_password
PG_DATABASE=todify2
JWT_SECRET=your_jwt_secret
AUTO_IMPORT_DATA=false
```

### Writer
```bash
PROJECT_NAME=writer
VERSION=latest
FRONTEND_PORT=8381
BACKEND_PORT=8380
OPENAI_API_KEY=
OPENAI_BASE_URL=
```

### Todify4
```bash
PROJECT_NAME=todify4
VERSION=latest
FRONTEND_PORT=8281
BACKEND_PORT=8280
NGINX_PORT=8288
DB_TYPE=sqlite
# 或使用 PostgreSQL
# DB_TYPE=postgresql
# PG_USER=postgres
# PG_PASSWORD=postgres
# PG_DATABASE=todify4
```

## 数据导入

### TPD2 数据导入

**自动导入（推荐）**：
部署包构建时会自动导出本地数据到 `data/init-data.sql`。

1. 在 `config/.env` 中设置 `AUTO_IMPORT_DATA=true`
2. 运行 `./scripts/deploy.sh`（会自动导入数据）

**手动导入**：
如果自动导入失败或需要导入其他数据：

```bash
# 使用导入脚本
./scripts/import-data.sh ../data/init-data.sql

# 或手动导入
docker cp ../data/init-data.sql tpd2-postgres:/tmp/init-data.sql
docker exec tpd2-postgres psql -U postgres -d todify2 -f /tmp/init-data.sql
```

**验证数据导入**：
```bash
docker exec tpd2-postgres psql -U postgres -d todify2 -c "SELECT COUNT(*) FROM brands;"
docker exec tpd2-postgres psql -U postgres -d todify2 -c "SELECT COUNT(*) FROM tech_categories;"
```

### Writer 数据导入

**自动导出**: 部署包构建时会自动导出本地 SQLite 数据到 `data/init-data.sql`（如果存在）。

**数据持久化**: Writer 数据通过 Docker Volume 自动持久化，首次部署会自动创建数据库。

**手动导入**（如果需要恢复数据）:
```bash
# 如果部署包包含数据文件
docker cp ../data/init-data.sql writer-backend:/tmp/import-data.sql
docker exec writer-backend sqlite3 /app/data/writer.db < /tmp/import-data.sql
```

### Todify4 数据导入

**自动导出**: 部署包构建时会自动导出本地 SQLite 数据到 `data/init-data.sql`（如果存在）。

**数据持久化**: Todify4 数据通过 Docker Volume 自动持久化，首次部署会自动创建数据库。

**手动导入**（如果需要恢复数据）:
```bash
# 如果部署包包含数据文件
docker cp ../data/init-data.sql todify4-backend:/tmp/import-data.sql
docker exec todify4-backend sqlite3 /app/data/todify2.db < /tmp/import-data.sql

# 如果还有配置数据库
if [ -f "../data/config-database.sql" ]; then
  docker cp ../data/config-database.sql todify4-backend:/tmp/config-database.sql
  docker exec todify4-backend sqlite3 /app/data/config-database.db < /tmp/config-database.sql
fi
```

## 故障排查

### 查看容器日志

```bash
# TPD2
docker logs tpd2-postgres
docker logs tpd2-backend
docker logs tpd2-frontend

# Writer
docker logs writer-backend
docker logs writer-frontend

# Todify4
docker logs todify4-backend
docker logs todify4-frontend
docker logs todify4-nginx
```

### 检查容器状态

```bash
docker ps --filter "name=项目名"
```

### 检查端口占用

```bash
netstat -tulpn | grep -E '8180|8181|8280|8281|8380|8381'
```

### 重新部署

如果部署失败，可以：

1. 清理旧服务：`./scripts/cleanup.sh --volumes`
2. 检查配置：`vi config/.env`
3. 重新部署：`./scripts/deploy.sh`

## 注意事项

1. **Mac M1/M2 构建**：打包脚本会自动检测并使用 `--platform linux/amd64` 构建镜像
2. **大文件上传**：Writer 镜像较大，建议使用支持断点续传的 SFTP 工具
3. **数据备份**：清理脚本默认保留数据卷，使用 `--volumes` 才会删除
4. **防火墙配置**：确保服务器已开放对应端口
5. **Nginx 网关**：Unified Portal 的 Nginx 需要配置各子项目的路由规则

## 项目更新升级

当子项目有新版本时，可以使用更新脚本进行**增量更新**，保留所有数据：

### 更新流程

```bash
# 1. 本地构建新版本部署包
cd /Volumes/Lexar/git/03T/TPD2
./deploy/build-deploy-package.sh v1.2  # 新版本号

# 2. 上传新版本部署包到服务器

# 3. 服务器上解压并更新
tar -xzf tpd2-deploy-v1.2.tar.gz
cd tpd2-deploy-v1.2
./scripts/update.sh v1.2
./scripts/verify.sh
```

**更新脚本特性**：
- ✅ 自动备份当前数据
- ✅ 保留所有数据卷（数据不丢失）
- ✅ 更新 Docker 镜像和容器
- ✅ 自动验证更新结果
- ✅ 支持回滚（备份文件在 `backups/` 目录）

详细说明请参考：`项目更新升级指南.md`

## 部署顺序建议

1. **TPD2** - 先部署，验证数据库和 API 正常
2. **Writer** - 部署，验证 AI 功能正常
3. **Todify4** - 最后部署，验证任务管理功能

每个项目部署完成后，运行 `verify.sh` 验证，确认无误后再部署下一个。
