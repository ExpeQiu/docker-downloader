server {
    listen 80;
    server_name _;

    # ============================================================
    # 1. 统一门户 (Root)
    # ============================================================
    location / {
        proxy_pass http://portal-frontend:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # ============================================================
    # 2. TPD2 (汽车推广)
    # ============================================================
    # 前端页面
    location /tpd2/ {
        proxy_pass http://tpd2-frontend:80/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
    
    # 后端 API (TPD2 前端配置的 API 路径需要指向 /tpd2-api)
    location /tpd2-api/ {
        proxy_pass http://tpd2-backend:3003/;
        proxy_set_header Host $host;
    }

    # 修复: TPD2 前端默认请求 /api/promotion 路径
    location /api/promotion/ {
        proxy_pass http://tpd2-backend:3003;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # 修复: TPD2 前端请求 /api/tech-categories 和 /api/tech-points
    location /api/tech- {
        proxy_pass http://tpd2-backend:3003;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # ============================================================
    # 3. Writer (AI 文案)
    # ============================================================
    # 修复: Writer Next.js 静态资源路径 (_next/static)
    location /_next/static/ {
        proxy_pass http://writer-frontend:3000/_next/static/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
    
    # 修复: Writer 公共资源路径 (如 icon.svg, favicon.ico 等)
    # 注意: 如果不同子系统有同名资源，可能会冲突。这里优先匹配 Writer 的特有资源
    location ~* \.(svg|png|jpg|jpeg|gif|ico)$ {
        try_files $uri @writer_assets;
    }
    location @writer_assets {
        proxy_pass http://writer-frontend:3000;
        proxy_set_header Host $host;
    }

    # 前端页面
    location /writer/ {
        proxy_pass http://writer-frontend:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # 后端 API
    location /writer-api/ {
        proxy_pass http://writer-backend:8000/;
        proxy_set_header Host $host;
    }

    # ============================================================
    # 4. Todify4 (任务管理)
    # ============================================================
    # 修复: Todify4 路径重写和资源加载
    location /todify/ {
        proxy_pass http://todify4-frontend:80/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header Accept-Encoding ""; # 禁用压缩以便 sub_filter 生效
        
        sub_filter_types text/html text/css application/javascript;
        sub_filter 'src="/assets/' 'src="/todify/assets/';
        sub_filter 'href="/assets/' 'href="/todify/assets/';
        sub_filter '"/api/v1' '"/todify-api/v1';
        sub_filter_once off;
    }

    location /todify/assets/ {
        proxy_pass http://todify4-frontend:80/assets/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # 修复: Todify4 静态资源路径 (static)
    location /todify/static/ {
        proxy_pass http://todify4-frontend:80/static/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # 后端 API
    location /todify-api/ {
        proxy_pass http://todify4-backend:8113/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # ============================================================
    # 5. 健康检查
    # ============================================================
    location /api/health {
        default_type application/json;
        return 200 '{"status":"ok", "timestamp":"$time_iso8601"}';
    }
}
