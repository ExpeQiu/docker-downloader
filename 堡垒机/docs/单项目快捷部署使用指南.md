# 单项目快捷部署使用指南

## 概述

为 TPD2、Writer、Todify4 三个项目分别创建了独立的快捷部署方案。本指南指导如何生成离线部署文件，并将其存放到指定的堡垒机部署目录中，最后上传至服务器进行部署。

## 本地部署包存储路径

生成的离线文件将分别存入以下目录（请确保目录存在）：

- **TPD2**: `/Volumes/Lexar/git/07Docker/堡垒机/TPD2-deploy-package`
- **Writer**: `/Volumes/Lexar/git/07Docker/堡垒机/writer-deploy-package`
- **Todify4**: `/Volumes/Lexar/git/07Docker/堡垒机/todify4-deploy-package`

## 部署流程

### 第一步：本地构建离线包

#### 1. TPD2 项目 (使用现有脚本)

TPD2 已包含自动打包脚本。

```bash
# 1. 进入项目目录
cd /Volumes/Lexar/git/03T/TPD2

# 2. 执行打包脚本
./scripts/deploy/build-deploy-package.sh v1.1

# 3. 将生成的文件移动到堡垒机部署目录
# 假设脚本生成的目录名为 tpd2-deploy-v1.1
rm -rf /Volumes/Lexar/git/07Docker/堡垒机/TPD2-deploy-package/*
cp -r tpd2-deploy-v1.1/* /Volumes/Lexar/git/07Docker/堡垒机/TPD2-deploy-package/

echo "TPD2 离线文件已就绪: /Volumes/Lexar/git/07Docker/堡垒机/TPD2-deploy-package"
```

#### 2. Writer 项目 (手动打包)

Writer 项目需手动构建并导出镜像到指定目录。

```bash
# 设置目标目录
TARGET_DIR="/Volumes/Lexar/git/07Docker/堡垒机/writer-deploy-package"
mkdir -p "$TARGET_DIR"
# 清理旧文件 (保留 README 和 docker-compose.yml 如果是手动维护的)
# rm -f "$TARGET_DIR"/*.tar

cd /Volumes/Lexar/git/03T/writer

# 1. 构建镜像 (指定 linux/amd64 架构)
# 后端
docker buildx build --platform linux/amd64 -t writer-backend:latest ./backend
# 前端 (传入 API 地址构建参数)
docker buildx build --platform linux/amd64 \
  --build-arg NEXT_PUBLIC_API_URL=http://<服务器IP>:8380 \
  -t writer-frontend:latest ./frontend

# 2. 导出镜像到目标目录
docker save -o "$TARGET_DIR/writer-backend.tar" writer-backend:latest
docker save -o "$TARGET_DIR/writer-frontend.tar" writer-frontend:latest

# 3. 复制配置文件
# 如果目标目录已有定制的 docker-compose.yml，可跳过此步
if [ ! -f "$TARGET_DIR/docker-compose.yml" ]; then
    cp docker/docker-compose.yml "$TARGET_DIR/"
fi

echo "Writer 离线文件已就绪: $TARGET_DIR"
```

#### 3. Todify4 项目 (手动打包)

Todify4 项目需手动构建并导出镜像到指定目录。

```bash
# 设置目标目录
TARGET_DIR="/Volumes/Lexar/git/07Docker/堡垒机/todify4-deploy-package"
mkdir -p "$TARGET_DIR"

cd /Volumes/Lexar/git/03T/todify4

# 1. 构建镜像
# 后端
docker buildx build --platform linux/amd64 -t todify4-backend:latest -f docker/Dockerfile ./backend
# 前端
docker buildx build --platform linux/amd64 -t todify4-frontend:latest ./frontend
# Nginx (如果需要)
docker buildx build --platform linux/amd64 -t todify4-nginx:latest ./docker

# 2. 导出镜像到目标目录
docker save -o "$TARGET_DIR/todify4-backend.tar" todify4-backend:latest
docker save -o "$TARGET_DIR/todify4-frontend.tar" todify4-frontend:latest
docker save -o "$TARGET_DIR/todify4-nginx.tar" todify4-nginx:latest

# 3. 复制配置文件
if [ ! -f "$TARGET_DIR/docker-compose.yml" ]; then
    cp docker/docker-compose.yml "$TARGET_DIR/"
fi

echo "Todify4 离线文件已就绪: $TARGET_DIR"
```

### 第二步：上传到服务器

将 `堡垒机/xxx-deploy-package` 目录下的所有文件上传到服务器的对应目录（建议在服务器 `/root/` 下创建同名目录）。

### 第三步：服务器端部署

#### 0. 清理旧项目 (重要)

在部署新版本前，必须清理服务器上正在运行的旧版本服务。

```bash
# 进入旧项目目录 (如果存在)
cd /root/<项目名>-deploy-package

# 1. 停止并删除容器
docker-compose down

# 2. (可选) 如果需要彻底重置数据，删除数据卷
# docker-compose down -v

# 3. (可选) 删除旧镜像以释放空间
# docker rmi <相关镜像名>

# 4. 清理旧文件 (备份配置文件后)
# cd .. && rm -rf <项目名>-deploy-package
```

#### 1. 部署新版本

```bash
# 进入上传的新项目目录
cd /root/<项目名>-deploy-package

# 1. 加载镜像
# 加载所有 tar 镜像
for img in *.tar; do docker load -i "$img"; done
# TPD2 可能是 images/*.tar
# for img in images/*.tar; do docker load -i "$img"; done

# 2. 启动服务
# 确保 docker-compose.yml 中的端口与规划一致
docker-compose up -d
```

#### 2. 验证部署

```bash
docker ps
# 检查相关容器状态是否为 Up
```

## 端口规划 (参考)

| 项目 | 前端端口 (宿主机:容器) | 后端端口 (宿主机:容器) | 数据库/其他 |
|------|-------------------|-------------------|------------|
| TPD2 | 8181:80 | 8180:3003 | PG: 5433:5432 |
| Writer | 8381:3000 | 8380:8000 | - |
| Todify4 | 8281:80 | 8280:8113 | Nginx: 8288:80 |

在启动前，请务必检查 `docker-compose.yml` 中的端口映射是否符合上述规划，避免端口冲突。
