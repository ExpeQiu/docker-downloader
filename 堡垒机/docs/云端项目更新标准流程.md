# 云端项目更新标准流程

## 概述

当子项目发生更新时，可以使用标准化的增量更新流程，**保留所有数据**，实现云端项目的平滑升级。

## 标准更新流程

### 第一步：本地构建新版本部署包

```bash
# TPD2
cd /Volumes/Lexar/git/03T/TPD2
./deploy/build-deploy-package.sh v1.2  # 新版本号

# Writer
cd /Volumes/Lexar/git/03T/writer
./deploy/build-deploy-package.sh latest

# Todify4
cd /Volumes/Lexar/git/03T/todify4
./deploy/build-deploy-package.sh latest
```

**自动执行**：
1. 构建新版本 Docker 镜像
2. 导出最新数据（如果存在）
3. 打包部署文件（包含更新脚本）

### 第二步：上传到服务器

使用 WindTerm 或其他 SFTP 工具上传新的部署包到服务器 `/root/` 目录。

### 第三步：服务器端增量更新

```bash
# 1. 解压新版本部署包
tar -xzf tpd2-deploy-v1.2.tar.gz
cd tpd2-deploy-v1.2

# 2. （可选）检查新版本配置变更
vi config/.env

# 3. 运行更新脚本（一键完成：备份+更新+验证）
./scripts/update.sh v1.2

# 4. 验证更新结果
./scripts/verify.sh
```

## 更新脚本功能

### ✅ 自动备份
- **数据库备份**: TPD2 自动导出 PostgreSQL dump，Writer/Todify4 备份 SQLite 文件
- **配置备份**: 自动备份 `.env` 配置文件
- **备份位置**: `backups/YYYYMMDD_HHMMSS/` 目录

### ✅ 数据保留
- **不删除数据卷**: 所有 Docker Volume 自动保留
- **数据零丢失**: 新容器使用相同的数据卷
- **配置保留**: 自动保留现有配置

### ✅ 平滑更新
- **停止旧容器**: 优雅停止旧版本容器
- **加载新镜像**: 自动加载新版本镜像
- **启动新容器**: 使用相同配置和数据卷启动新容器
- **自动验证**: 更新后自动验证服务状态

### ✅ 支持回滚
- **备份文件**: 所有备份文件保存在 `backups/` 目录
- **快速回滚**: 可以使用备份文件快速回滚到旧版本

## 更新示例

### TPD2 更新示例

```bash
# 当前版本: v1.1 → 目标版本: v1.2

cd /root/tpd2-deploy-v1.2
./scripts/update.sh v1.2

# 输出示例：
# === TPD2 项目更新脚本 ===
# 当前版本: v1.1
# 目标版本: v1.2
# >>> 备份当前数据...
#   ✓ 数据库备份完成
#   ✓ 配置文件已备份
# >>> 加载新版本镜像...
#   ✓ 镜像加载完成
# >>> 停止并删除旧容器...
# >>> 启动新版本容器...
# >>> 验证更新...
#   ✓ 所有容器运行正常
# === 更新完成 ===
```

### Writer 更新示例

```bash
cd /root/writer-deploy-latest
./scripts/update.sh latest
```

### Todify4 更新示例

```bash
cd /root/todify4-deploy-latest
./scripts/update.sh latest
```

## 更新前后对比

| 特性 | 旧方式（重新部署） | 新方式（增量更新） |
|------|------------------|------------------|
| **数据保留** | ❌ 需要手动备份恢复 | ✅ 自动保留 |
| **停机时间** | 较长（5-10分钟） | ✅ 较短（1-2分钟） |
| **操作复杂度** | 高（多步骤） | ✅ 低（一键更新） |
| **风险** | 较高（可能丢失数据） | ✅ 较低（自动备份） |
| **回滚** | 困难 | ✅ 简单（使用备份） |
| **配置保留** | 需要重新配置 | ✅ 自动保留 |

## 完整更新检查清单

### 更新前
- [ ] 本地已构建新版本部署包
- [ ] 新版本部署包已上传到服务器
- [ ] 已检查新版本配置变更（如有）
- [ ] 已通知相关人员（如需要）
- [ ] 已确认更新窗口时间

### 更新中
- [ ] 运行更新脚本
- [ ] 检查备份是否成功创建
- [ ] 检查新容器是否正常启动
- [ ] 验证服务是否正常响应

### 更新后
- [ ] 运行验证脚本 `./scripts/verify.sh`
- [ ] 检查数据完整性
- [ ] 测试关键功能
- [ ] 检查日志是否有错误
- [ ] 确认网络连接正常（如果使用 Unified Portal）
- [ ] 验证版本号已更新

## 回滚操作

如果更新失败，可以快速回滚：

```bash
# 1. 停止新版本容器
docker stop tpd2-postgres tpd2-backend tpd2-frontend

# 2. 查看备份文件
ls -lh backups/最新时间戳/

# 3. 恢复数据库（TPD2）
docker exec tpd2-postgres psql -U postgres -d todify2 < backups/最新时间戳/database-backup.sql

# 4. 恢复配置文件
cp backups/最新时间戳/.env.backup config/.env

# 5. 使用旧版本重新部署
# 重新上传旧版本部署包，运行 deploy.sh
```

## 注意事项

1. **版本兼容性**: 确保新版本与旧版本数据库结构兼容
2. **配置变更**: 检查新版本是否有配置变更，需要更新 `.env` 文件
3. **数据备份**: 更新脚本会自动备份，但建议在更新前手动备份重要数据
4. **测试环境**: 建议先在测试环境验证更新流程
5. **回滚准备**: 更新前确保有旧版本部署包，以便快速回滚
6. **更新窗口**: 选择业务低峰期进行更新

## 常见问题

### Q1: 更新后数据会丢失吗？

**A:** 不会。更新脚本会自动保留所有数据卷，数据不会丢失。同时会自动备份数据库和配置。

### Q2: 更新需要多长时间？

**A:** 通常 2-5 分钟，取决于：
- 镜像加载时间（如果镜像较大）
- 容器启动时间
- 数据库连接时间

### Q3: 更新期间服务会中断吗？

**A:** 会有短暂中断（通常 < 1 分钟），因为需要停止旧容器并启动新容器。

### Q4: 可以跳过版本更新吗？

**A:** 可以，但建议按顺序更新，避免数据库结构不兼容问题。

### Q5: 更新失败怎么办？

**A:** 
1. 查看更新日志
2. 检查容器状态: `docker ps -a`
3. 查看容器日志: `docker logs 容器名`
4. 使用备份文件回滚

## 最佳实践

1. **定期更新**: 建议定期更新到最新版本
2. **测试先行**: 在测试环境验证更新流程
3. **备份重要**: 更新前手动备份关键数据（虽然脚本会自动备份）
4. **监控日志**: 更新后检查日志确保无错误
5. **验证功能**: 更新后测试关键功能
6. **版本记录**: 记录每次更新的版本号和变更内容

## 更新脚本位置

所有项目的更新脚本已包含在部署包中：

- **TPD2**: `scripts/update.sh`
- **Writer**: `scripts/update.sh`
- **Todify4**: `scripts/update.sh`

## 标准流程总结

```
本地构建 → 上传服务器 → 解压部署包 → 运行更新脚本 → 验证更新
   ↓           ↓            ↓            ↓            ↓
自动导出数据  自动备份数据  保留数据卷   自动验证    测试功能
```

**关键优势**：
- ✅ 数据零丢失
- ✅ 一键更新
- ✅ 自动备份
- ✅ 支持回滚
- ✅ 平滑升级
